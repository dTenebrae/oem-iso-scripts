#!/bin/bash

FILE=$1

[[ -d "unpacked" ]] && rm -rf unpacked
mkdir unpacked
echo "Unpacking iso..."
bsdtar -x -v -C unpacked -f $FILE
echo "Changing permissions..."
chmod -R a-x+X,u-x+rwX,go-wx+rX unpacked/

#####################################################################################
# TODO check files on existance
echo "Copying kickstarter config..."
cp config/ks.cfg unpacked/

echo "Patching isolinux.cfg..."
patch unpacked/isolinux/isolinux.cfg patches/isolinux.patch

echo "Patching grub.cfg..."
patch unpacked/EFI/BOOT/grub.cfg patches/grub.patch

#####################################################################################

echo "Creating new iso..."
# create new iso after changes are made
# TODO label to variable
# TODO output iso to variable
mkisofs -r -T -J -V "redos-MUROM-7.3.1 x86_64" -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table -o iso/redos-test.iso unpacked
