#!/bin/bash

# sudo dnf install -y genisoimage bsdtar diffutils patch

# red color for output. Usage: echo "${RED} some text ${NC}"
RED='\033[0;31m'
NC='\033[0m'

INPUT_FILE=$1
OUTPUT_FILE=$2

####################### Sanity checks & preparations ################################
if [ "$EUID" -ne 0 ]
  then echo "Please run as root"
  exit
fi

if [ -z "$1" ]
then
    echo "No input file supplied"
    exit
fi

if [ ! -f "$INPUT_FILE" ]
then
    echo "Input file didn't exists"
    exit
fi

# if no second argument - create output path by changing input
if [ -z "$2" ]
  then
      OUTPUT_FILE=$(printf '%s\n' "${INPUT_FILE%.iso}-kickstart.iso")
fi

if [ ! -d "config" ]
then
    echo "No config folder in working directory"
    exit
fi

if [[ ! -f config/ks.cfg || ! -f config/isolinux_patched.cfg  || ! -f config/grub_patched.cfg ]]
then
    echo "Some of necessary config files absent"
    exit
fi

[[ -d "unpacked" ]] && rm -rf unpacked
[[ -d "patches" ]] && rm -rf patches

mkdir -p unpacked/base-iso
mkdir -p unpacked/squashfs
mkdir patches

################################# Unpacking #########################################

echo "Unpacking iso"
bsdtar -x -v -C unpacked/base-iso -f $INPUT_FILE
echo "Changing permissions"
# TODO replace
chmod -R a-x+X,u-x+rwX,go-wx+rX unpacked/base-iso

# find label name, take first instance and replace escape sequance of space with space itself
LABEL=$(grep -ri 'linuxefi'  unpacked/base-iso/EFI/BOOT/grub.cfg | awk -F '[:= ]' '{print $6}' | tail -n 1 | sed 's/\\x20/ /g')

# Unsquash liveCD
[[ -d "_squashfs" ]] && rm -rf _squashfs
mkdir -p _squashfs/mnt

unsquashfs -f -d _squashfs unpacked/base-iso/LiveOS/squashfs.img

echo "Mounting live cd"
mount -o loop _squashfs/LiveOS/rootfs.img _squashfs/mnt

echo "Copying it to users folder"
rsync -ahr --progress _squashfs/mnt/* unpacked/squashfs

echo "Unmounting live cd"
umount -R _squashfs/mnt
rm -rf _squashfs

echo "Changing permissions"
# TODO replace
chmod -R a-x+X,u-x+rwX,go-wx+rX unpacked/squashfs

################################### Patching ########################################

echo "Copying kickstarter config"
cp config/ks.cfg unpacked/base-iso/

echo "Patching isolinux.cfg"
diff -Naur unpacked/base-iso/isolinux/isolinux.cfg config/isolinux_patched.cfg > patches/isolinux.patch
patch unpacked/base-iso/isolinux/isolinux.cfg patches/isolinux.patch

echo "Patching grub.cfg"
diff -Naur unpacked/base-iso/EFI/BOOT/grub.cfg config/grub_patched.cfg > patches/grub.patch
patch unpacked/base-iso/EFI/BOOT/grub.cfg patches/grub.patch

#####################################################################################

echo "Creating new iso"
# create new iso after changes are made
mkisofs -r -T -J -V "$LABEL" -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table -o $OUTPUT_FILE unpacked/base-iso
